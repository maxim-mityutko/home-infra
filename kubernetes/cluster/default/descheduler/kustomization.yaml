apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-system
helmCharts:
    - name: descheduler
      namespace: kube-system
      releaseName: descheduler
      version: v0.30.1
      repo: https://kubernetes-sigs.github.io/descheduler/
      valuesInline:
        kind: Deployment
        replicas: 1
        
        cmdOptions:
          v: 4  # verbosity: log all reasons why any pod is not evictable
        deschedulingInterval: 15m
        deschedulerPolicyAPIVersion: descheduler/v1alpha2
        deschedulerPolicy:
          profiles:
            - name: balancing
              pluginConfig:
                - name: DefaultEvictor
                  args:
                    nodeFit: true
                - name: LowNodeUtilization
                  args:
                    thresholds:
                      # cpu: 40
                      memory: 60
                      pods: 25
                    targetThresholds:
                      # cpu : 60
                      memory: 70
                      pods: 35
              plugins:
                balance:
                  enabled:
                    - LowNodeUtilization
            - name: health
              pluginConfig:
              - name: DefaultEvictor
                args:
                  nodeFit: false
                  evictSystemCriticalPods: true
                  evictFailedBarePods: true
                  evictDaemonSetPods: true
                  evictLocalStoragePods: true
                  ignorePvcPods: false
              - name: RemoveFailedPods
                args:
                  reasons:
                    - BackOff
                  includingInitContainers: true
                  minPodLifetimeSeconds: 600
              - name: RemovePodsHavingTooManyRestarts
                args:
                  podRestartThreshold: 10
                  includingInitContainers: true
              plugins:
                deschedule:
                  enabled:
                    - RemoveFailedPods
                    - RemovePodsHavingTooManyRestarts

        rbac:
          create: true
        serviceAccount:
          create: false
        service:
          enabled: true
        serviceMonitor:
          enabled: false
        
        resources:
          requests: 
            cpu: 50m
            memory: 25Mi
          limits:
            cpu: 100m
            memory: 50Mi
            
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000

        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10258
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 60
