apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-system
helmCharts:
    - name: descheduler
      namespace: kube-system
      releaseName: descheduler
      version: v0.30.1
      repo: https://kubernetes-sigs.github.io/descheduler/
      valuesInline:
        kind: Deployment
        replicas: 1
        
        deschedulingInterval: 15m
        deschedulerPolicyAPIVersion: descheduler/v1alpha2
        deschedulerPolicy:
          evictDaemonSetPods: true
          profiles:
            - name: balancing
              pluginConfig:
                - name: DefaultEvictor
                  args:
                    nodeFit: true
                - name: LowNodeUtilization
                  args:
                    thresholds:
                      cpu: 40
                      memory: 60
                    targetThresholds:
                      cpu : 60
                      memory: 70
              plugins:
                balance:
                  enabled:
                    - LowNodeUtilization
            - name: health
              pluginConfig:
                - name: DefaultEvictor
                  args:
                    nodeFit: true
                - name: RemovePodsHavingTooManyRestarts
                  args:
                    podRestartThreshold: 5
                    includingInitContainers: true
                    states: 
                      - CrashLoopBackOff
              plugins:
                deschedule:
                  enabled:
                    - RemovePodsHavingTooManyRestarts

        rbac:
          create: true
        serviceAccount:
          create: false
        service:
          enabled: true
        serviceMonitor:
          enabled: false
        
        resources:
          requests: 
            cpu: 50m
            memory: 100m
          limits:
            cpu: 100m
            memory: 100m
            
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000

        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10258
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 60
# patches:
#   - path: patch.yaml