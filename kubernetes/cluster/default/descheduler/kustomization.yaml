apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-system
helmCharts:
    - name: descheduler
      namespace: kube-system
      releaseName: descheduler
      version: v0.33.0
      repo: https://kubernetes-sigs.github.io/descheduler/
      valuesInline:
        kind: CronJob
        cronJobApiVersion: "batch/v1"
        schedule: "35 * * * *"
        successfulJobsHistoryLimit: 3
        failedJobsHistoryLimit: 1
        activeDeadlineSeconds: 120

        priorityClassName: system-cluster-critical
        resources:
          requests: 
            cpu: 50m
            memory: 25Mi
          limits:
            cpu: 100m
            memory: 50Mi

        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000

        cmdOptions:
          v: 4  # verbosity: log all reasons why any pod is not evictable

        rbac:
          create: true
        serviceAccount:
          create: true
        service:
          enabled: false
        serviceMonitor:
          enabled: false

        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10258
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 60

        deschedulerPolicyAPIVersion: "descheduler/v1alpha2"
        deschedulerPolicy:
          maxNoOfPodsToEvictTotal: 5
          metricsCollector:
            enabled: true
          profiles:
            - name: balancing
              pluginConfig:
                - name: DefaultEvictor
                  args:
                    nodeFit: true
                    minReplicas: 2
                    minPodAge: 12h
                    evictLocalStoragePods: true
                    evictDaemonSetPods: false
                    evictSystemCriticalPods: false
                    ignorePvcPods: false
                    ignorePodsWithoutPDB: false
                    # noEvictionPolicy: Mandatory
                    # podProtections:
                    #   defaultDisabled:
                    #     - PodsWithLocalStorage
                    #     - FailedBarePods
                - name: LowNodeUtilization
                  args:
                    thresholds:
                      cpu: 40
                      memory: 50
                      pods: 25
                    targetThresholds:
                      cpu : 60
                      memory: 60
                      pods: 30
                    evictionLimits:
                      node: 3
                    metricsUtilization:
                      source: KubernetesMetrics
              plugins:
                balance:
                  enabled:
                    - LowNodeUtilization
            - name: health
              pluginConfig:
              - name: DefaultEvictor
                args:
                  nodeFit: false
                  evictSystemCriticalPods: true
                  evictFailedBarePods: true
                  evictDaemonSetPods: true
                  evictLocalStoragePods: true
                  ignorePvcPods: false
                  # podProtections:
                  #   defaultDisabled:
                  #     - PodsWithLocalStorage
                  #     - DaemonSetPods
                  #     - SystemCriticalPods
                  #     - FailedBarePods
              - name: RemoveFailedPods
                args:
                  reasons:
                    - BackOff
                  includingInitContainers: true
                  minPodLifetimeSeconds: 3600
                  excludeOwnerKinds:
                    - Job
              - name: RemovePodsHavingTooManyRestarts
                args:
                  podRestartThreshold: 10
                  includingInitContainers: true
              plugins:
                deschedule:
                  enabled:
                    - RemoveFailedPods
                    - RemovePodsHavingTooManyRestarts
