apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kube-dashboard
resources:
  - dns-endpoint.yaml
  - secret.yaml
helmCharts:
  - name: oauth2-proxy
    namespace: kube-dashboard
    releaseName: oauth2-proxy
    version: 7.12.8
    repo: https://oauth2-proxy.github.io/manifests
    valuesInline:
      config:
        existingSecret: oauth2-proxy
        google: {}
        configFile: |-
          email_domains = [ "*" ]
          upstreams = [ "http://kubernetes-dashboard" ]
      extraArgs:
        provider: oidc
        provider-display-name: Authentik
        oidc-issuer-url: https://auth.brhd.io/application/o/kubernetes-dashboard/
        skip-provider-button: "false"
        pass-authorization-header: "true" 
        cookie-refresh: 15m
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: public
          cert-manager.io/cluster-issuer: lets-encrypt
        path: /
        pathType: ImplementationSpecific
        hosts:
         - k8s-dash.brhd.io

      livenessProbe:
        enabled: true
        initialDelaySeconds: 0
        timeoutSeconds: 1
      readinessProbe:
        enabled: true
        initialDelaySeconds: 0
        timeoutSeconds: 5
        periodSeconds: 10
        successThreshold: 1

      serviceAccount:
        enabled: true
      securityContext:
        enabled: true
      
      alphaConfig:
        enabled: false
      authenticatedEmailsFile:
        enabled: false
      htpasswdFile:
        enabled: false
      autoscaling:
        enabled: false
      redis:
        enabled: false
      checkDeprecation: true
      metrics:
        enabled: false
  - name: kubernetes-dashboard
    namespace: kube-dashboard
    releaseName: kubernetes-dashboard
    version: 6.0.8
    repo: https://kubernetes.github.io/dashboard/
    valuesInline: 
      extraArgs:
        - --enable-skip-login
        - --enable-insecure-login
      resources:
        requests:
          cpu: 50m
          memory: 50Mi
        limits:
          cpu: 100m
          memory: 150Mi
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: public
          cert-manager.io/cluster-issuer: lets-encrypt
        hosts:
          - k8s-dash1.brhd.io
          # - k8s.brhd.io
      metricsScraper:
        enabled: true
        resources:
          requests:
            cpu: 50m
            memory: 50Mi
          limits:
            cpu: 50m
            memory: 50Mi
      rbac:
        create: true
      serviceAccount:
        create: true
#       app:
#         mode: 'dashboard'
#         ingress:
#           enabled: true
#           hosts:
#             - k8s.brhd.io
#           useDefaultIngressClass: true
#           useDefaultAnnotations: true
#           issuer:
#             name: lets-encrypt
#             scope: cluster
#       auth:
#         resources:
#           requests:
#             cpu: 25m
#             memory: 25Mi
#           limits:
#             cpu: 50m
#             memory: 50Mi
#       web:
#         resources:
#           requests:
#             cpu: 25m
#             memory: 25Mi
#           limits:
#             cpu: 50m
#             memory: 50Mi
#       metricsScraper:
#         enabled: true
#         resources:
#           requests:
#             cpu: 25m
#             memory: 25Mi
#           limits:
#             cpu: 50m
#             memory: 50Mi
#       metrics-server:
#         enabled: false
#       kong:
#         enabled: true
#       cert-manager:
#         enabled: false
#       nginx:
#         enabled: false
#       extras:
#         serviceMonitor:
#           enabled: false
# replacements:
# - source:
#     kind: Secret
#     name: kubernetes-dashboard-token
#     fieldPath: data.token
#   targets:
#   - select:
#       kind: Ingress
#       name: kubernetes-dashboard
#     fieldPaths:
#     - metadata.annotations.[nginx.ingress.kubernetes.io~1configuration-snippet]
#     options:
#       delimiter: "/"
#       index: 1
#       create: true
# patches:
#   - target:
#       kind: Ingress
#       name: kubernetes-dashboard
#     patch: |-
#       - op: add
#         path: /metadata/annotations/nginx.ingress.kubernetes.io~1configuration-snippet
#         valueFrom:
#           secretKeyRef:
#             name: kubernetes-dashboard-token
#             key: token
