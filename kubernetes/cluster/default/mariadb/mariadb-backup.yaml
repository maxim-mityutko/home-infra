# MariaDB backup using dump strategy.
#
# Extend the `DBS` array in command arguments with the name of databases that should be backed up.
# For example: DBS=("db1" "db2");
# The script will dump database contents, archive the `sql` file into `tar.gz` and cleanup after itself. The timestamp
# is added to all file names.
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mariadb-backup
  namespace: default
  labels:
    app.kubernetes.io/name: mariadb
spec:
  schedule: '0 3 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
#      successfulJobsHistoryLimit: 1
#      failedJobsHistoryLimit: 2
      ttlSecondsAfterFinished: 259200 # 3 days
      template:
        spec:
          containers:
            - name: mariadb-backup
              image: mariadb:10.11.6
              envFrom:
                - secretRef:
                    name: mariadb
              volumeMounts:
                - name: mariadb-backup
                  mountPath: /backup
              command: [ "/bin/bash" ]
              args:
                - -c
                - >
                  DBS=("speedtest_tracker" "guacamole" "shinobi");
                  for DB in "${DBS[@]}"; 
                  do FILE_NAME=$DB"_"$(date +%Y%m%d%H%M);
                  echo "Current database and timestamp: "$FILE_NAME;
                  cd /tmp
                  && mariadb-dump 
                  --databases $DB
                  --add-drop-database 
                  --host=mariadb 
                  --password=$(MARIADB_ROOT_PASSWORD) 
                  --lock-tables 
                  > $FILE_NAME.sql
                  && tar -czf $FILE_NAME.tar.gz $FILE_NAME.sql
                  && rm $FILE_NAME.sql
                  && mv $FILE_NAME.tar.gz /backup/;
                  echo "Backup successful!";
                  done
              resources:
                requests:
                  cpu: 10m
                  memory: 50Mi
                limits:
                  cpu: 20m
                  memory: 50Mi
          volumes:
            - name: mariadb-backup
              persistentVolumeClaim:
                claimName: mariadb-backup
          restartPolicy: Never
