# TODO: Revisit and setup BGPAdvertisement if / when BGP becomes available on the Omada
# NOTE: Could not make L2Advertisement work properly on master nodes, hence moved everything to workers
#   Ref: https://metallb.io/troubleshooting/#metallb-is-not-advertising-my-service-from-my-control-plane-nodes-or-from-my-single-node-cluster
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources: 
  - namespace.yaml
  - ip-pool.yaml
helmCharts:
  - name: metallb
    namespace: metallb-system
    releaseName: metallb
    version: 0.15.2
    repo: https://metallb.github.io/metallb
    valuesInline:
      rbac:
        create: true
      controller:
        enabled: true
        logLevel: info
        nodeSelector:
          node.kubernetes.io/microk8s-controlplane: microk8s-controlplane
        tolerations:
          - key: "node.kubernetes.io/unschedulable"
            operator: Exists
        livenessProbe:
          enabled: true
          initialDelaySeconds: 10
          periodSeconds: 60
        readinessProbe:
          enabled: true
          initialDelaySeconds: 10
          periodSeconds: 60
      speaker:
        enabled: true
        logLevel: info
        frr:
          enabled: false
        podAnnotations:
          # Default NET_RAW capability used in the chart is not enough and LB stopped working with the following:
          # {
          #   "caller":"announcer.go:122",
          #   "error":"creating ARP responder for \"ens18\": listen packet bc:24:11:d8:50:d9: bind: permission denied",
          #   "interface":"ens18","level":"error",
          #   "msg":"failed to create ARP responder",
          #   "op":"createARPResponder","ts":"2025-10-09T10:43:29Z"
          # }
          # FIXME: Disabling AppArmor seems to help, however it is unclear why the LB stopped working in the first place
          container.apparmor.security.beta.kubernetes.io/speaker: unconfined
        resources:
          limits:
            cpu: 100m
        livenessProbe:
          enabled: true
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          enabled: true
          initialDelaySeconds: 10
          periodSeconds: 30
      crds:
        enabled: true
      frrk8s:
        enabled: false
