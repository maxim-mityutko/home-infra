apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: extras
resources:
  - secret.yaml
  # - volumes.yaml
  - dns-endpoint.yaml
helmCharts:
  - name: couchdb
    namespace: extras
    releaseName: couchdb
    version: 4.5.3
    repo: https://apache.github.io/couchdb-helm
    valuesInline:
      clusterSize: 1
      allowAdminParty: false
      autoSetup:
        enabled: true
      createAdminSecret: false
      networkPolicy:
        enabled: false
      persistentVolume:
        enabled: true
        accessModes:
          - ReadWriteOnce
          - ReadOnlyMany
        size: 10Gi
        storageClass: nfs-subdir
        # existingClaims:
        #   - volumeName: couchdb-data-iscsi
        #     claimName: couchdb-data-iscsi
        #     persistentVolumeName: couchdb-data-iscsi
        #     volumeSource: persistentVolumeClaim

      enableSearch: false

      service:
        enabled: true
        type: ClusterIP
        externalPort: 5984
        targetPort: 5984

      ingress:
        enabled: true
        hosts:
          - couchdb.brhd.io
        path: /
        annotations:
          kubernetes.io/ingress.class: public
          cert-manager.io/cluster-issuer: lets-encrypt

      resources:
        requests:
          cpu: 100m
          memory: 100Mi
        limits:
          cpu: 200m
          memory: 250Mi

      couchdbConfig:
        couchdb:
          uuid: vfexns2c4a9ku265j6jzepu9x7hk
        # cluster:
        #   q: 8 # Create 8 shards for each database
        chttpd:
          bind_address: any
          require_valid_user: true
        httpd:
          WWW-Authenticate: "Basic realm=\"administrator\""

      livenessProbe:
        enabled: true
        failureThreshold: 3
        initialDelaySeconds: 0
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 1
      readinessProbe:
        enabled: true
        failureThreshold: 3
        initialDelaySeconds: 0
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 1

      prometheusPort:
        enabled: false

      sidecars: {}

      placementConfig:
        enabled: false
