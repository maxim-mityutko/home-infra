# IMPORTANT
# Immich requires 'pgvecto-rs' extension for PostgreSQL, which might require
# some level of maintenance, check: https://immich.app/docs/administration/postgres-standalone/

# TODO: custom configuration and OAuth
# TODO: move Nextcloud / Google apps alternatives into separate namespace
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: extras
resources:
  - secret.yaml
  - config.yaml
  - pv-pvc-data.yaml
  - dns-endpoint.yaml
helmCharts:
  - name: immich
    namespace: extras
    releaseName: immich
    version: 0.7.0
    repo: https://immich-app.github.io/immich-charts
    valuesInline:
      # Ref: https://github.com/immich-app/immich-charts/blob/main/charts/immich/values.yaml
      # Ref: https://github.com/bjw-s/helm-charts/blob/main/charts/library/common/values.yaml
      env:
      envFrom:
        - configMapRef:
            name: immich
        - secretRef: 
            name: immich

      immich:
        metrics:
          enabled: false
        persistence:
          library:
            existingClaim: immich-data
        # Ref: https://immich.app/docs/install/config-file/
        # configuration:
        #   trash:
        #     enabled: true
        #     days: 30
        #   storageTemplate:
        #     enabled: true
        #     template: "{{y}}/{{MM}}/{{filename}}"
      
      # Dependencies
      postgresql:
        enabled: false
      redis:
        enabled: false

      # Immich Components
      server:
        enabled: true
        probes:
          liveness:
            spec:
              initialDelaySeconds: 120
          readiness:
            spec:
              initialDelaySeconds: 120
        ingress:
          main:
            enabled: true
            annotations:
              kubernetes.io/ingress.class: public
              cert-manager.io/cluster-issuer: lets-encrypt
              nginx.ingress.kubernetes.io/proxy-body-size: "0"
            hosts:
              - host: photos.brhd.io
                paths:
                  - path: "/"
      machine-learning:
        enabled: false
        env:
          TRANSFORMERS_CACHE: /cache
        persistence:
          cache:
            enabled: true
            size: 10Gi
            # Optional: Set this to pvc to avoid downloading the ML models every start.
            # type: emptyDir
            accessMode: ReadWriteMany
            storageClass: nfs-subdir
