# Container: https://github.com/project-zot/zot/pkgs/container/zot
# Helm: https://github.com/project-zot/helm-charts/blob/main/charts/zot/values.yaml
# Docs: https://zotregistry.dev
# TODO: add revision history limit
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: extras
resources:
  - dns-endpoint.yaml
helmCharts:
  - name: zot
    namespace: extras
    releaseName: zot
    version: 0.1.87
    repo: http://zotregistry.dev/helm-charts
    valuesInline:
      image:
        repository: ghcr.io/project-zot/zot
      serviceAccount:
        create: true
      serviceHeadless:
        enabled: false
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: public
          cert-manager.io/cluster-issuer: lets-encrypt
          nginx.ingress.kubernetes.io/proxy-body-size: '0'
        className: public
        hosts:
          - host: cr.brhd.io
            paths:
              - path: /
        tls: []
      startupProbe:
        initialDelaySeconds: 30
        periodSeconds: 10
        failureThreshold: 3
      mountConfig: true
      configFiles:
        config.json: |-
          {
            "storage": { "rootDirectory": "/var/lib/registry" },
            "http": { "address": "0.0.0.0", "port": "5000" },
            "log": { "level": "info" },
            "extensions": {
              "search": {"enable": true},
              "ui": {"enable": true},
              "mgmt": { "enable": true },
              "sync": {
                "enable": true,
                "registries": [
                  {
                    "urls": ["https://index.docker.io"],
                    "content": [{"prefix": "**", "destination": "/docker.io"}],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": ["https://ghcr.io"],
                    "content": [{"prefix": "**", "destination": "/ghcr.io"}],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": ["https://quay.io"],
                    "content": [{"prefix": "**", "destination": "/quay.io"}],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": ["https://gcr.io"],
                    "content": [{"prefix": "**", "destination": "/gcr.io"}],
                    "onDemand": true,
                    "tlsVerify": true
                  },
                  {
                    "urls": ["https://registry.k8s.io"],
                    "content": [{"prefix": "**", "destination": "/k8s.io"}],
                    "onDemand": true,
                    "tlsVerify": true
                  }
                ]
              },
              "scrub": {
                "interval": "24h"
              }
            }
          }
      persistence: true
      pvc:
        create: true
        accessModes: ["ReadWriteOnce"]
        storage: 5Gi
        storageClassName: openebs-hostpath
      # List of environment variables to set on the container
      env: []
      strategy:
        type: RollingUpdate
      metrics:
        enabled: false
        serviceMonitor:
          enabled: false
patches:
  - path: patch.yaml