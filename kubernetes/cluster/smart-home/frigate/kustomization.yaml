# Ref:
#   - Helm Chart:   https://github.com/blakeblackshear/blakeshome-charts/tree/master/charts/frigate
#   - Helm Values:  https://github.com/blakeblackshear/blakeshome-charts/blob/master/charts/frigate/values.yaml
#   - Containers:   https://github.com/blakeblackshear/frigate/pkgs/container/frigate
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: smart-home
resources:
  - secret.yaml
  - volume.yaml
  - dns-endpoint.yaml
helmCharts:
  - name:  frigate
    namespace: smart-home
    releaseName:  frigate
    version: 7.5.1
    repo: https://blakeblackshear.github.io/blakeshome-charts/
    valuesInline:
      # Container and Environment
      strategyType: Recreate
      nodeSelector:
        beta.kubernetes.io/arch: amd64
        nvidia.com/gpu.present: "true"
      image:
        tag: 0.13.2-tensorrt # ??? amd64nvidia
      env:
        TZ: Europe/Amsterdam
        YOLO_MODELS: yolov7-320
        USE_FP16: "false"
      envFromSecrets: 
        - frigate
      resources:
        requests:
          cpu: 100m
          memory: 100M
        # limits:
      shmSize: 1Gi

      # Hardware
      coral:
        enabled: false
        # hostPath: "/dev/..."
      gpu:
        nvidia:
          enabled: true

      # Frigate Config
      # Ref:
      #   - Basic Configuration: https://docs.frigate.video/configuration/
      #   - Full Reference Config: https://docs.frigate.video/configuration/reference/
      config: |
        mqtt:
          enabled: True
          host: mqtt.smart-home.svc.cluster.local
          port: 1883
          topic_prefix: frigate
          stats_interval: 60

        detectors:
          # coral:
          #   type: edgetpu
          #   device: usb
          # https://docs.frigate.video/configuration/object_detectors/#nvidia-tensorrt-detector
          tensor:
            type: tensorrt
            device: 0
        
        model:
          path: /config/model_cache/tensorrt/yolov7-320.trt
          input_tensor: nchw
          input_pixel_format: rgb
          width: 320
          height: 320

        snapshots:
          enabled: True
          retain:
            default: 30

        record:
          enabled: True
          retain:
            days: 7   # TODO: potentially change to 0 to disable and focus on events only
            mode: motion
          events:
            retain:
              default: 30
              mode: motion

        # Ref:
        #   - Birdseye: https://docs.frigate.video/configuration/birdseye/
        birdseye:
          enabled: False
          mode: continuous

        go2rtc:
          streams:
            garden: 
              - rtsp://{FRIGATE_RTSP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@{FRIGATE_CAM_01_IP}:554/stream1
            garden_substream:
              - rtsp://{FRIGATE_RTSP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@{FRIGATE_CAM_01_IP}:554/stream2


        # Ref: 
        #   - Camera Configuration:   https://docs.frigate.video/configuration/cameras
        #   - Hardware Acceleration:  https://docs.frigate.video/configuration/hardware_acceleration#nvidia-gpus
        cameras:
          garden:
            ffmpeg:
              hwaccel_args: preset-nvidia-h264
              inputs:
                - path: rtsp://127.0.0.1:8554/garden
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/garden_substream
                  roles:
                    - detect

      # Ingress
      ingress:
        enabled: true
        annotations: 
            kubernetes.io/ingress.class: public
            cert-manager.io/cluster-issuer: lets-encrypt
        hosts:
          - host: frigate.brhd.io
            paths: 
              - "/"

      # Persistence
      persistence:
        config:
          enabled: true
          storageClass: nfs-subdir
          size: 10Gi
          skipuninstall: true
          accessMode: ReadWriteOnce
        media:
          enabled: true
          existingClaim: frigate-media

      # Probes
      probes:
        liveness:
          enabled: false
          initialDelaySeconds: 30
          failureThreshold: 5
          timeoutSeconds: 10
        readiness:
          enabled: false
          initialDelaySeconds: 30
          failureThreshold: 5
          timeoutSeconds: 10
        startup:
          enabled: false
          failureThreshold: 30
          periodSeconds: 10
